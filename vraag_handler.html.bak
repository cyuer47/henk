<!doctype html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <title>Vragen</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 420px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .modal-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
      }
      .modal-buttons button {
        padding: 12px;
        font-size: 16px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
      }
      .btn-good {
        background: #4caf50;
        color: white;
      }
      .btn-typo {
        background: #2196f3;
        color: white;
      }
      .btn-wrong {
        background: #f44336;
        color: white;
      }
      .score-board {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 16px;
      }
      .current-question {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid #2196f3;
      }
      .helper {
        color: #666;
      }
      .small-muted {
        color: #777;
        font-size: 0.9em;
      }
      /* presence indicator */
      .presence-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .presence-on {
        background: #4caf50;
      }
      .presence-away {
        background: #ffc107;
      }
      .presence-off {
        background: #bbb;
      }
      .student-away {
        opacity: 0.65;
        filter: grayscale(40%);
      }
      .student-focused {
        font-weight: 700;
      }
      .last-seen {
        font-size: 0.85em;
        color: #666;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a class="btn-text" href="dashboard.html"
        ><svg
          xmlns="http://www.w3.org/2000/svg"
          height="24px"
          viewBox="0 -960 960 960"
          width="24px"
          fill="var(--svg-icons)"
        >
          <path
            d="m368-417 202 202-90 89-354-354 354-354 90 89-202 202h466v126H368Z"
          /></svg
      ></a>
      <h1 class="app-title">Overhoring</h1>
      <div
        id="klass-info"
        style="text-align: center; margin-bottom: 20px"
      ></div>

      <div class="card">
        <h3>Vraag Beheer</h3>
        <div id="status-area"></div>
        <div style="margin-top: 12px">
          <button id="btn-clear" class="btn-danger" style="display: none">
            Stop huidige vraag
          </button>
          <button id="btn-next" class="btn-primary">Volgende vraag</button>
          <a
            id="cast-link"
            class="btn-primary"
            href="#"
            target="_blank"
            style="display: none"
            >Toon castscherm (voor projectie)</a
          >
        </div>
        <div style="margin-top: 12px">
          <a id="stop-session" class="btn-danger" href="#" style="display: none"
            >Stop sessie</a
          >
        </div>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <h3>Scorebord</h3>
        <div class="score-board" id="scoreboard-container"></div>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <h3>Vragen toevoegen</h3>
        <form id="addQuestionForm">
          <label>Vraag</label><input name="vraag" required />
          <label>Antwoord</label><input name="antwoord" required />
          <div style="margin-top: 12px">
            <button class="btn-secondary" type="submit">Opslaan</button>
          </div>
        </form>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <h3>
          Recente antwoorden
          <span
            id="pending-count"
            style="
              display: none;
              margin-left: 10px;
              padding: 4px 8px;
              border-radius: 10px;
              background: #ffc107;
              color: #111;
              font-weight: 700;
              font-size: 0.9em;
            "
          ></span>
        </h3>
        <div id="recent-answers-container"></div>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <h3>Leerlingen in de sessie</h3>
        <div
          id="presence-summary"
          class="small-muted"
          style="margin-bottom: 8px"
        >
          Online: 0
        </div>
        <div id="students-list-container"></div>
      </div>

      <div style="height: 16px"></div>

      <div class="card">
        <h3>Toets incidenten & gebande leerlingen</h3>
        <div id="violations-list" class="small-muted">Laden...</div>
        <div style="height: 8px"></div>
        <h4 style="margin-top: 8px">Gebande leerlingen</h4>
        <div id="banned-list" class="small-muted">Laden...</div>
      </div>
    </div>

    <div id="gradeModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()" aria-label="Close">
          ‚úñ
        </button>
        <h4>Beoordeel antwoord</h4>
        <div style="text-align: left; margin-top: 20px">
          <p>
            <strong>Gegeven antwoord:</strong>
            <span id="modalStudentAnswer"></span>
          </p>
          <p>
            <strong>Correct antwoord:</strong>
            <span id="modalCorrectAnswer"></span>
          </p>
        </div>
        <p style="margin-top: 20px">Selecteer de status voor dit antwoord:</p>
        <div class="modal-buttons">
          <button class="btn-good" onclick="gradeModalSubmit('goed')">
            ‚úÖ Goed (10 punten)
          </button>
          <button class="btn-typo" onclick="gradeModalSubmit('typfout')">
            üìù Typfout (5 punten)
          </button>
          <button class="btn-wrong" onclick="gradeModalSubmit('fout')">
            ‚ùå Fout (0 punten)
          </button>
        </div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get("sessie");
      if (!sessionId) {
        document.body.innerHTML =
          '<div class="container"><h2>Geen sessie geselecteerd.</h2></div>';
        throw new Error("sessie param required");
      }

      const token = localStorage.getItem("token");
      if (!token) {
        window.location =
          "login.html?redirecturi=" +
          encodeURIComponent("vraag_handler.html?sessie=" + sessionId);
      }

      const headers = {
        Authorization: "Bearer " + token,
        "Content-Type": "application/json",
      };

      async function loadSession() {
        try {
          const res = await fetch("/sessies/" + sessionId, { headers });
          if (!res.ok) throw new Error("Failed to load session");
          const data = await res.json();
          const sess = data.sess;
          document.querySelector(".app-title").textContent =
            "Overhoring - " + (sess.klasnaam || "");
          document.getElementById("klass-info").innerHTML =
            '<span class="chip">Klascode: <strong>' +
            (sess.klascode || "") +
            "</strong></span>";

          const statusArea = document.getElementById("status-area");
          if (sess.current_question_id && data.currentQuestion) {
            statusArea.innerHTML = `<div class="current-question"><h4>Huidige vraag voor alle leerlingen:</h4><p style='font-size:18px;font-weight:bold;margin:10px 0;'>${escapeHtml(
              data.currentQuestion.vraag,
            )} <span id='answerCount' style='color:#555'>(Antwoorden: ${
              data.answerCount
            })</span></p><p class='helper'>Alle leerlingen kunnen nu deze vraag beantwoorden.</p></div>`;
            document.getElementById("btn-clear").style.display = "inline-block";
          } else if (params.get("status") === "no_more_questions") {
            statusArea.innerHTML = `<div class='current-question' style='background:#fff3cd;border-color:#ffe066;'><h4>Let op:</h4><p style='font-size:16px;font-weight:bold;margin:10px 0;'>Alle vragen zijn beantwoord! Voeg nieuwe vragen toe of be√´indig de sessie.</p></div>`;
            document.getElementById("btn-clear").style.display = "none";
          } else {
            statusArea.innerHTML =
              '<p class="helper">Geen actieve vraag. Verstuur een vraag naar alle leerlingen.</p>';
            document.getElementById("btn-clear").style.display = "none";
          }

          document.getElementById("cast-link").href =
            "cast.html?sessie=" + sessionId;
          document.getElementById("cast-link").style.display = "inline-block";

          // Show and wire up the Stop Session button when sessie is active
          const stopEl = document.getElementById("stop-session");
          if (sess.actief) {
            stopEl.style.display = "inline-block";
            stopEl.href = "#";
            stopEl.onclick = async (e) => {
              e.preventDefault();
              if (
                !confirm("Stop huidige sessie? Dit logt alle leerlingen uit.")
              )
                return;
              try {
                const res = await fetch(`/sessies/${sessionId}/stop`, {
                  method: "POST",
                  headers,
                });
                const j = await res.json();
                if (j.ok) {
                  alert("Sessie gestopt");
                  await loadSession();
                  await refreshRecentAnswers();
                  await refreshScoreboard();
                } else {
                  alert(j.error || "Kon sessie niet stoppen");
                }
              } catch (err) {
                console.error(err);
                alert("Fout bij stoppen sessie");
              }
            };

            // If this is a toets, show lock and end-toets UI
            if (sess.is_toets) {
              let lockBtn = document.getElementById("lock-toets-btn");
              if (!lockBtn) {
                lockBtn = document.createElement("button");
                lockBtn.id = "lock-toets-btn";
                lockBtn.className = "btn-secondary";
                lockBtn.style.marginLeft = "8px";
                lockBtn.textContent = sess.locked
                  ? "Unlock toets"
                  : "Lock toets";
                lockBtn.onclick = async (ev) => {
                  try {
                    const res = await fetch(`/sessies/${sessionId}/lock`, {
                      method: "POST",
                      headers,
                      body: JSON.stringify({ lock: sess.locked ? 0 : 1 }),
                    });
                    const j = await res.json();
                    if (j.ok) {
                      alert("Lock status gewijzigd");
                      await loadSession();
                    } else alert(j.error || "Kon lock niet wijzigen");
                  } catch (err) {
                    console.error(err);
                    alert("Fout bij lock wijziging");
                  }
                };
                stopEl.parentElement.appendChild(lockBtn);
              } else {
                lockBtn.textContent = sess.locked
                  ? "Unlock toets"
                  : "Lock toets";
              }

              let endBtn = document.getElementById("end-toets-btn");
              if (!endBtn) {
                endBtn = document.createElement("button");
                endBtn.id = "end-toets-btn";
                endBtn.className = "btn-danger";
                endBtn.style.marginLeft = "8px";
                endBtn.textContent = "Voorbij (einde toets)";
                endBtn.onclick = async (ev) => {
                  ev.preventDefault();
                  if (
                    !confirm(
                      "Be√´indig de toets? Alle leerlingen worden uitgelogd.",
                    )
                    )
                    return;
                  try {
                    const res = await fetch(`/sessies/${sessionId}/end-toets`, {
                      method: "POST",
                      headers,
                    });
                    const j = await res.json();
                    if (j.ok) {
                      alert("Toets be√´indigd");
                      await loadSession();
                    } else alert(j.error || "Kon toets niet be√´indigen");
                  } catch (err) {
                    console.error(err);
                    alert("Fout bij be√´indigen toets");
                  }
                };
                stopEl.parentElement.appendChild(endBtn);
              }
            }
